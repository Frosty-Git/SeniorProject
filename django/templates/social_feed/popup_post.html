{% load static %}
{% load humanize %}

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous"></script>

<style>
    /* .invalid {
        border: 2px solid red;
    } */

    .hide {
        visibility: hidden;
    }
</style>

{% if image %}
    <input hidden id="user_profile" value="{{ image.url }}">
{% else %}
    <input hidden id="user_profile" value="{% static 'images/noprofilepic.jpg' type='image/jpg' %}">
{% endif %}

<!-- Included in Profile Feed -->
    <div class="modal fade" id="postmodal{{ post.id }}" tabindex="-1" aria-labelledby="myPostModalLabel" aria-hidden="true"  style="color:black;">
        <div class="modal-dialog modal-lg modal-dialog-centered" >
          <div class="modal-content">
            <form method="post" action='{% url "feed:popup_post" post.id %}' id="popup_form">
                {% csrf_token %}
              
                <div class="modal-header">
                  <h5 class="modal-title" id="myPostModalLabel"></h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
              
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col" style="border-right: 1px gray solid; margin-top: auto; margin-bottom: auto;">
                                <p style="word-break: break-all;">{{ post.text }}</p>
                                {% if post.type_post == "SongPost" %}
                                    <iframe src="https://open.spotify.com/embed/track/{{ post.song }}" width="300" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
                                {% endif %}
                                <br>
                                by <a href="{% url 'user:profile' user.id %}">@{{ post.user_profile_fk.user.username }}</a>
                                <p>at {{ post.date_last_updated|naturaltime }}</p>
    
                            </div>
                            <div class="col">
                                <ul id="comment_list{{ post.id }}" style="overflow-y: scroll; height: auto; max-height:500px">
                                    {% for comment in post.comment_set.all %}
                                        <li class="post">
                                            <a href="{% url 'user:profile' comment.user_profile_fk.user.id %}">
                                                {% if comment.user_profile_fk.profilepic %}
                                                    <img src="{{ comment.user_profile_fk.profilepic.url }}" width="40" height="40" class="d-inline-block align-top">
                                                {% else %}
                                                    <img src="{% static 'images/noprofilepic.jpg' type='image/jpg' %}" width="40" height="40" class="d-inline-block align-top" alt="...">
                                                {% endif %}
                                            </a>
                                            <br>
                                            <a href="{% url 'user:profile' user.id %}">@{{ comment.user_profile_fk.user.username }}</a>
                                            <br>
                                            {{ comment.text }} 
                                            <br>
                                            {{ comment.date_last_updated|naturaltime }}
                                        </li>
                                        <br>
                                    {% empty %}
                                        <li class="post" id="no_comment{{ post.id }}">There are no comments.</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>  
    
                <div class="modal-footer">
                    <textarea id="comment_text{{ post.id }}" class="form-control" aria-label="With textarea" name="comment_text"></textarea>
                    <button id="close" type="button" class="btn btn-default" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="commentbtn{{ post.id }} btn btn-primary" style="display: block">Comment</button>
                    <button id="load{{ post.id }}" class="btn btn-primary" type="button" disabled style="display: none">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span class="visually-hidden">Loading...</span>
                    </button>
                </div>
              </div>
              <script>
                $('.commentbtn{{ post.id }}').click(function(e) {
                    $('#load{{ post.id }}').show();
                    $('.commentbtn{{ post.id }}').hide();
                    e.preventDefault();
                    var comment_text = $('#comment_text{{ post.id }}').val();
                    if (checkText(comment_text)) {
                        var pic_url = $('#user_profile').val();
                        $.ajax({
                            type: 'POST',
                            url: '{% url "feed:popup_post" post.id %}',
                            data: {
                                csrfmiddlewaretoken: '{{ csrf_token }}',
                                comment_text: comment_text,
                            },
                            success: function(json){
                                if (json['status'] == 'ok') {
                                    var date = moment().fromNow();
                                    var previous_comment_count = parseInt($('#comment_count{{ post.id }}').text());
                                    $('#comment_text{{ post.id }}').val("");
                                    setTimeout(function() {
                                        $('#load{{ post.id }}').hide();
                                        $('.commentbtn{{ post.id }}').show();
                                        if (previous_comment_count == 0) {
                                            $('#no_comment{{ post.id }}').remove();
                                        }
                                        $('#comment_list{{ post.id }}').append("<li class='post'><a href='{% url 'user:profile' user.id %}'>" + 
                                                                '<img src=' + pic_url + ' width="40" height="40" class="d-inline-block align-top">' +
                                                                "</a><br>" +
                                                                '<a href="{% url "user:profile" user.id %}">@{{ user.username }}</a><br>' +
                                                                comment_text + '<br>' +
                                                                date + '<br></li>');
                                        $('#comment_count{{ post.id }}').text(previous_comment_count + 1);
                                    }, 2000);
                                }

                            },
                            error: function(xhr, errmsg, err) {}
                        })
                        return false;
                    }
                })

                function checkText(comment_text) {
                    return !comment_text ? false : true;
                }
            </script>
            </form>
            
          </div>
        </div>
    </div>

