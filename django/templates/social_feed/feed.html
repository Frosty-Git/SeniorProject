{% extends 'base.html' %}
{% load static %}

{% block title %} Post {% endblock %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <h1>Social Feed</h1>

    <form class='post_form' method='POST' action='/feed/create_post/'>
        {% csrf_token %}
        {{ postform }}
        <input type='submit' value='Create Post' class='post_form'>
    </form>

    <h4>Posts</h4>

    {% for post in post_list %}
    <br>
    <ul>
        <li class="post">
        {% if post.user_profile_fk.user.id == user.id %}
            <a href="{% url 'user:profile' post.user_profile_fk.user.id %}">
                {% if post.user_profile_fk.profilepic %}
                    <img src="{{ post.user_profile_fk.profilepic.url }}" width="80" height="80" class="d-inline-block align-top">
                {% else %}
                    <img src="{% static 'images/noprofilepic.jpg' type='image/jpg' %}" width="80" height="80" class="d-inline-block align-top" alt="...">
                {% endif %}
            </a>
            <br>
            <a href="{% url 'user:profile' post.user_profile_fk.user.id %}">@{{ post.user_profile_fk.user.username }}</a>
            <br>
            <a href="{% url 'feed:comment' post.id %}">{{ post.text }}</a>
            <br>
            {% if post.type_post == "SongPost" %}
                <iframe src="https://open.spotify.com/embed/track/{{ post.song }}" width="300" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
            {% endif %}
            <br>

            <p>{{ post.date_last_updated }}</p>
            
        {% else %}
            <a href="{% url 'user:other_profile' post.user_profile_fk.user.id %}">
                {% if post.user_profile_fk.profilepic %}
                    <img src="{{ post.user_profile_fk.profilepic.url }}" width="80" height="80" class="d-inline-block align-top">
                {% else %}
                    <img src="{% static 'images/noprofilepic.jpg' type='image/jpg' %}" width="80" height="80" class="d-inline-block align-top" alt="...">
                {% endif %}
            </a>
            <br>
            <a href="{% url 'user:other_profile' post.user_profile_fk.user.id %}">@{{ post.user_profile_fk.user.username }}</a>
            <br>
            <a href="{% url 'feed:comment' post.id %}">{{ post.text }}</a>
            <br>
            {% if post.type_post == "SongPost" %}
                <iframe src="https://open.spotify.com/embed/track/{{ post.song }}" width="300" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
            {% endif %}
            <br>
            <p>{{ post.date_last_updated }}</p>
        {% endif %}

        
        <button type="button" class="upvoteBtn btn btn-secondary {% for upvote in upvote_posts %} {% if upvote.post_to.id == post.id %} active {% endif %} {% endfor %}" id="upvote{{ post.id }}" data-id='{{ post.id }}' data-action='like'>Upvote</button>
        <span id='total_votes{{ post.id }}'>{{ post.upvotes }}</span>
        <button type="button" class="downvoteBtn btn btn-secondary {% for downvote in downvote_posts %} {% if downvote.post_to.id == post.id %} active {% endif %} {% endfor %}" id="downvote{{ post.id }}" data-id='{{ post.id }}' data-action='dislike'>Downvote</button>
        
        <br>
        <script>
            $('#upvote{{ post.id }}').click(function(e) {
                var post_id = document.getElementById('upvote{{ post.id }}').getAttribute('data-id');
                e.preventDefault();
                $.ajax({
                    type: 'POST',
                    url: '{% url "feed:upvote" %}',
                    data: {
                        post_id: post_id,
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        action: 'like',
                    },
                    success: function(json){
                        if (json['status'] == 'ok') {
                            var previous_likes = parseInt($('#total_votes{{ post.id }}').text());
                            var previous_action = $('#upvote{{ post.id }}').data('action');
                            $('#total_votes{{ post.id }}').text(previous_likes + 1);
                            $('#upvote{{ post.id }}').addClass("active");
                        }
                        if (json['status'] == 'undo_upvote') {
                            var previous_likes = parseInt($('#total_votes{{ post.id }}').text());
                            var previous_action = $('#upvote{{ post.id }}').data('action');
                            $('#total_votes{{ post.id }}').text(previous_likes - 1);
                            $('#upvote{{ post.id }}').removeClass("active");           
                        }
                        if (json['status'] == 'switch') {
                            var previous_likes = parseInt($('#total_votes{{ post.id }}').text());
                            var previous_action = $('#upvote{{ post.id }}').data('action');
                            $('#total_votes{{ post.id }}').text(previous_likes + 2);
                            $('#upvote{{ post.id }}').addClass("active");
                            $('#downvote{{ post.id }}').removeClass("active");
                        }
                    },
                    error: function(xhr, errmsg, err) {}
                })
            })
          
        
            $('#downvote{{ post.id }}').click(function(e) {
                var post_id = document.getElementById('downvote{{ post.id }}').getAttribute('data-id');
                e.preventDefault();
                $.ajax({
                    type: 'POST',
                    url: '{% url "feed:downvote" %}',
                    data: {
                        post_id: post_id,
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        action: 'dislike',
                    },
                    success: function(json){
                        if (json['status'] == 'ok') {
                            var previous_action = $('#downvote{{ post.id }}').data('action');
                            var previous_likes = parseInt($('#total_votes{{ post.id }}').text());
                            $('#total_votes{{ post.id }}').text(previous_likes - 1);
                            $('#downvote{{ post.id }}').addClass("active");
                        }
                        if (json['status'] == 'undo_downvote') {
                            var previous_action = $('#downvote{{ post.id }}').data('action');
                            var previous_likes = parseInt($('#total_votes{{ post.id }}').text());
                            $('#total_votes{{ post.id }}').text(previous_likes + 1);
                            $('#downvote{{ post.id }}').removeClass("active");
                        }
                        if (json['status'] == 'switch') {
                            var previous_action = $('#downvote{{ post.id }}').data('action');
                            var previous_likes = parseInt($('#total_votes{{ post.id }}').text());
                            $('#total_votes{{ post.id }}').text(previous_likes - 2);
                            $('#downvote{{ post.id }}').addClass("active");
                            $('#upvote{{ post.id }}').removeClass("active");
                        }
                    },
                    error: function(xhr, errmsg, err) {}
                })
            })
        </script>
    </li>
    </ul>
    <br>
    {% endfor %}


{% endblock %}